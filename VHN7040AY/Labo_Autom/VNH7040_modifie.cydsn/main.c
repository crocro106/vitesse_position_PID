/* ========================================
 *
 * Copyright YOUR COMPANY, THE YEAR
 * All Rights Reserved
 * UNPUBLISHED, LICENSED SOFTWARE.
 *
 * CONFIDENTIAL AND PROPRIETARY INFORMATION
 * WHICH IS THE PROPERTY OF your company.
 *
 * ========================================
*/
#include "project.h"
#include "proj_types.h"
#include "UART_XG.h"
#include "State_machine.h"

#define PT_PAR_TOUR 4096

const int32 carree[512]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000};
const int32 triangle[512]={0,4,8,12,16,20,24,27,31,35,39,43,47,51,55,59,63,67,71,75,78,82,86,90,94,98,102,106,110,114,118,122,125,129,133,137,141,145,149,153,157,161,165,169,173,176,180,184,188,192,196,200,204,208,212,216,220,224,227,231,235,239,243,247,251,255,259,263,267,271,275,278,282,286,290,294,298,302,306,310,314,318,322,325,329,333,337,341,345,349,353,357,361,365,369,373,376,380,384,388,392,396,400,404,408,412,416,420,424,427,431,435,439,443,447,451,455,459,463,467,471,475,478,482,486,490,494,498,502,506,510,514,518,522,525,529,533,537,541,545,549,553,557,561,565,569,573,576,580,584,588,592,596,600,604,608,612,616,620,624,627,631,635,639,643,647,651,655,659,663,667,671,675,678,682,686,690,694,698,702,706,710,714,718,722,725,729,733,737,741,745,749,753,757,761,765,769,773,776,780,784,788,792,796,800,804,808,812,816,820,824,827,831,835,839,843,847,851,855,859,863,867,871,875,878,882,886,890,894,898,902,906,910,914,918,922,925,929,933,937,941,945,949,953,957,961,965,969,973,976,980,984,988,992,996,1000,996,992,988,984,980,977,973,969,965,961,957,953,949,945,941,937,934,930,926,922,918,914,910,906,902,898,895,891,887,883,879,875,871,867,863,859,855,852,848,844,840,836,832,828,824,820,816,812,809,805,801,797,793,789,785,781,777,773,770,766,762,758,754,750,746,742,738,734,730,727,723,719,715,711,707,703,699,695,691,687,684,680,676,672,668,664,660,656,652,648,645,641,637,633,629,625,621,617,613,609,605,602,598,594,590,586,582,578,574,570,566,562,559,555,551,547,543,539,535,531,527,523,520,516,512,508,504,500,496,492,488,484,480,477,473,469,465,461,457,453,449,445,441,437,434,430,426,422,418,414,410,406,402,398,395,391,387,383,379,375,371,367,363,359,355,352,348,344,340,336,332,328,324,320,316,312,309,305,301,297,293,289,285,281,277,273,270,266,262,258,254,250,246,242,238,234,230,227,223,219,215,211,207,203,199,195,191,187,184,180,176,172,168,164,160,156,152,148,145,141,137,133,129,125,121,117,113,109,105,102,98,94,90,86,82,78,74,70,66,62,59,55,51,47,43,39,35,31,27,23,20,16,12,8,4,0};
const int32 sinus[512]={500,506,512,518,525,531,537,543,549,555,561,567,573,579,585,592,598,604,610,616,621,627,633,639,645,651,657,663,668,674,680,686,691,697,703,708,714,719,725,730,736,741,746,752,757,762,767,773,778,783,788,793,798,803,808,812,817,822,827,831,836,840,845,849,854,858,862,866,870,875,879,883,887,890,894,898,902,905,909,912,916,919,922,926,929,932,935,938,941,944,947,949,952,955,957,960,962,964,966,969,971,973,975,977,978,980,982,983,985,986,988,989,990,992,993,994,995,995,996,997,998,998,999,999,999,1000,1000,1000,1000,1000,1000,1000,999,999,999,998,998,997,996,995,995,994,993,992,990,989,988,986,985,983,982,980,978,977,975,973,971,969,966,964,962,960,957,955,952,949,947,944,941,938,935,932,929,926,922,919,916,912,909,905,902,898,894,890,887,883,879,875,870,866,862,858,854,849,845,840,836,831,827,822,817,812,808,803,798,793,788,783,778,773,767,762,757,752,746,741,736,730,725,719,714,708,703,697,691,686,680,674,668,663,657,651,645,639,633,627,621,616,610,604,598,592,585,579,573,567,561,555,549,543,537,531,525,518,512,506,500,494,488,482,475,469,463,457,451,445,439,433,427,421,415,408,402,396,390,384,379,373,367,361,355,349,343,337,332,326,320,314,309,303,297,292,286,281,275,270,264,259,254,248,243,238,233,227,222,217,212,207,202,197,192,188,183,178,173,169,164,160,155,151,146,142,138,134,130,125,121,117,113,110,106,102,98,95,91,88,84,81,78,74,71,68,65,62,59,56,53,51,48,45,43,40,38,36,34,31,29,27,25,23,22,20,18,17,15,14,12,11,10,8,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,8,10,11,12,14,15,17,18,20,22,23,25,27,29,31,34,36,38,40,43,45,48,51,53,56,59,62,65,68,71,74,78,81,84,88,91,95,98,102,106,110,113,117,121,125,130,134,138,142,146,151,155,160,164,169,173,178,183,188,192,197,202,207,212,217,222,227,233,238,243,248,254,259,264,270,275,281,286,292,297,303,309,314,320,326,332,337,343,349,355,361,367,373,379,384,390,396,402,408,415,421,427,433,439,445,451,457,463,469,475,482,488,494};
const int32 dent_de_scie[512]={0,2,4,6,8,10,12,14,16,18,20,22,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,115,117,119,121,123,125,127,129,131,133,135,137,139,141,143,145,147,149,151,153,155,157,159,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,205,207,209,211,213,215,217,219,221,223,225,227,229,231,233,235,237,239,241,243,245,247,249,250,252,254,256,258,260,262,264,266,268,270,272,274,276,278,280,282,284,286,288,290,292,294,295,297,299,301,303,305,307,309,311,313,315,317,319,321,323,325,327,329,331,333,335,337,339,341,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,374,376,378,380,382,384,386,387,389,391,393,395,397,399,401,403,405,407,409,411,413,415,417,419,421,423,425,427,429,431,432,434,436,438,440,442,444,446,448,450,452,454,456,458,460,462,464,466,468,470,472,474,476,477,479,481,483,485,487,489,491,493,495,497,499,501,503,505,507,509,511,513,515,517,519,521,523,524,526,528,530,532,534,536,538,540,542,544,546,548,550,552,554,556,558,560,562,564,566,568,569,571,573,575,577,579,581,583,585,587,589,591,593,595,597,599,601,603,605,607,609,611,613,614,616,618,620,622,624,626,628,630,632,634,636,638,640,642,644,646,648,650,652,654,656,658,659,661,663,665,667,669,671,673,675,677,679,681,683,685,687,689,691,693,695,697,699,701,703,705,706,708,710,712,714,716,718,720,722,724,726,728,730,732,734,736,738,740,742,744,746,748,750,751,753,755,757,759,761,763,765,767,769,771,773,775,777,779,781,783,785,787,789,791,793,795,796,798,800,802,804,806,808,810,812,814,816,818,820,822,824,826,828,830,832,834,836,838,840,841,843,845,847,849,851,853,855,857,859,861,863,865,867,869,871,873,875,877,879,881,883,885,886,888,890,892,894,896,898,900,902,904,906,908,910,912,914,916,918,920,922,924,926,928,930,932,933,935,937,939,941,943,945,947,949,951,953,955,957,959,961,963,965,967,969,971,973,975,977,978,980,982,984,986,988,990,992,994,996,998,1000};
/*
const int32 carree[36]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000,1000};
const int32 rampe[36]={0,29,57,86,114,143,171,200,229,257,286,314,343,371,400,429,457,486,514,543,571,600,629,657,686,714,743,771,800,829,857,886,914,943,971,1000};
const int32 triangle[36]={0,56,111,167,222,278,333,389,444,500,556,611,667,722,778,833,889,944,1000,944,889,833,778,722,667,611,556,500,444,389,333,278,222,167,111,56};
const int32 echelon[36]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1000};
const int32 sinus[36]={500,587,671,750,821,883,933,970,992,1000,992,970,933,883,821,750,671,587,500,413,329,250,179,117,67,30,8,0,8,30,67,117,179,250,329,413};
const int32 dent_de_scie[36]={0,29,57,86,114,143,171,200,229,257,286,314,343,371,400,429,457,486,514,543,571,600,629,657,686,714,743,771,800,829,857,886,914,943,971,1000};
*/
volatile bool debug;
bool marche_bool;
volatile uint16 i;
volatile uint32 time=0;
volatile int32 val1,val2,val2_1,val2_2;
volatile config param;
volatile uint8 param_ok,sent;
volatile const int32 *pointeur_gen;
volatile float gain_idac,gain_pwm1;
volatile int32 offset_idac,offset_pwm1,pwm1_valeur;
volatile int32 consigne,epsilon,spid1,spid2;
volatile int32 erreur_int_pid1,erreur_av_pid1,erreur_int_pid2,erreur_av_pid2,out_deriv_av1,out_deriv_av2;
volatile uint32 index_gen;
// State pointer
void (*statefunc)() = init;

/* User ISR function definition */
CY_ISR(SYSTICK_ISR)  // frequence fixe reglable avec les fonction "systick" permet de generer le comptage tps et le signaux
{
    time++;
    if ((param.type_consigne == 'E')||(param.type_consigne=='F')) //on gere le cas de la rampe ou echelon
    {
        if(index_gen<(PT_CONS-1))
        {
           index_gen=(((PT_CONS*(int32)time*(int32)param.cons_per_den)/(1000*(int32)param.cons_per_num)))%PT_CONS;
        }
        else
        {
            index_gen=PT_CONS-1;
        }
        
    }
    else
    {
         index_gen=(((PT_CONS*time*param.cons_per_den)/(1000*param.cons_per_num)))%(PT_CONS);
        if(index_gen==PT_CONS-1) time=0;
    }
}
CY_ISR(FECH_ISR) 
{  
    FECH_ClearInterrupt(FECH_INTR_MASK_TC );
/*    if(gen_out_ok)
    {
        DO1_Write(carree[index_gen]>500);
        IDAC_SetValue(offset_idac+(uint32)(gain_idac*(float)(*(pointeur_gen+index_gen)))); // generation consigne avec IDAC
        PWM_WriteCompare1(offset_pwm1+(uint32)(gain_pwm1*(float)(*(pointeur_gen+index_gen)))); // generation spid 1
    }*/
    if(pwm1_valeur>=500)
    {
       //IN1_L298_Write(0);
       //IN2_L298_Write(1);

       sensrotation_Write(01);
       PWM_WriteCompare((pwm1_valeur-500)<<1); 
    }
    else
    {
       //IN1_L298_Write(1);
       //IN2_L298_Write(0);
       sensrotation_Write(02);
       PWM_WriteCompare((500-pwm1_valeur)<<1); 
        
    }
    //PWM_WriteCompare(pwm1_valeur);
    sent=1;
    val2=((360*((int32)QuadDec_ReadCounter()-(65535/2)))/PT_PAR_TOUR);//+val2_1+val2_2)/3;
    val2_2=val2_1;
    val2_1=val2;
    if(Stat_dir_Read()) val1=(60*(int32)Speed_ReadCapture()*1000)/((int32)param.Tech*PT_PAR_TOUR);
    else  val1= -(60*(int32)Speed_ReadCapture()*1000)/((int32)param.Tech*PT_PAR_TOUR);
}


int main(void)
{
    statefunc= init;
    marche_bool=false;
    pointeur_gen=carree;
    CyGlobalIntEnable; /* Enable global interrupts. */
    /* Place your initialization/startup code here (e.g. MyInst_Start()) */
    QuadDec_Start();
    for(;;)
    {
        /* Place your application code here. */
        (*statefunc)();  
    }
    return 1; // should not get here
}

/* [] END OF FILE */
